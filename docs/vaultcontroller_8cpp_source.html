<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>develop-manual: dde-file-manager/dde-file-manager-lib/controllers/vaultcontroller.cpp 源文件</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">develop-manual
   &#160;<span id="projectnumber">2021.02</span>
   </div>
   <div id="projectbrief">develop manual about develop-manual</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'搜索');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','搜索');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('vaultcontroller_8cpp_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">vaultcontroller.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">* Copyright (C) 2019 Deepin Technology Co., Ltd.</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">* Author:     Gary Wang &lt;wzc782970009@gmail.com&gt;</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">* Maintainer: Gary Wang &lt;wangzichong@deepin.com&gt;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">* This program is free software: you can redistribute it and/or modify</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">* it under the terms of the GNU General Public License as published by</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">* the Free Software Foundation, either version 3 of the License, or</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">* any later version.</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">* This program is distributed in the hope that it will be useful,</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">* but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">* GNU General Public License for more details.</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">* You should have received a copy of the GNU General Public License</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">* along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">*/</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;vaultcontroller.h&quot;</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;models/vaultfileinfo.h&quot;</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;dfileservices.h&quot;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;dfilewatcher.h&quot;</span></div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;dfileproxywatcher.h&quot;</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &quot;vaulthandle.h&quot;</span></div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &quot;vaulterrorcode.h&quot;</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &quot;dfmeventdispatcher.h&quot;</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &quot;dfilestatisticsjob.h&quot;</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &quot;log/dfmLogManager.h&quot;</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &quot;log/filterAppender.h&quot;</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &quot;appcontroller.h&quot;</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &quot;singleton.h&quot;</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &quot;dstorageinfo.h&quot;</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &quot;models/desktopfileinfo.h&quot;</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;tag/tagmanager.h&quot;</span></div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;shutil/fileutils.h&quot;</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &quot;shutil/dfmfilelistfile.h&quot;</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &quot;usershare/shareinfo.h&quot;</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &quot;app/define.h&quot;</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &quot;usershare/usersharemanager.h&quot;</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &quot;dialogs/dialogmanager.h&quot;</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &quot;dfmevent.h&quot;</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &quot;../vault/vaultglobaldefine.h&quot;</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &lt;QProcess&gt;</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &lt;QStandardPaths&gt;</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &lt;QStorageInfo&gt;</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &lt;QDBusInterface&gt;</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &lt;QDBusPendingCall&gt;</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#include &lt;qplatformdefs.h&gt;</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#include &lt;unistd.h&gt;</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<a class="code" href="class_vault_controller.html">VaultController</a> *VaultController::cryfs = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="keywordtype">bool</span> VaultController::m_isBigFileDeleting = <span class="keyword">false</span>;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="class_vault_controller_private.html">   62</a></span>&#160;<span class="keyword">class </span><a class="code" href="class_vault_controller_private.html">VaultControllerPrivate</a></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;{</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keyword">explicit</span> <a class="code" href="class_vault_controller_private.html">VaultControllerPrivate</a>(<a class="code" href="class_vault_controller.html">VaultController</a> *CryFs);</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    <a class="code" href="class_cry_fs_handle.html">CryFsHandle</a> *m_cryFsHandle;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="keyword">private</span>:</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <a class="code" href="class_vault_controller.html">VaultController</a> *q_ptr;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    Q_DECLARE_PUBLIC(<a class="code" href="class_vault_controller.html">VaultController</a>)</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;};</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;VaultControllerPrivate::VaultControllerPrivate(<a class="code" href="class_vault_controller.html">VaultController</a> *CryFs): q_ptr(CryFs)</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;{</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;}</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno"><a class="line" href="class_vault_dir_iterator.html">   79</a></span>&#160;<span class="keyword">class </span><a class="code" href="class_vault_dir_iterator.html">VaultDirIterator</a> : <span class="keyword">public</span> <a class="code" href="class_d_dir_iterator.html">DDirIterator</a></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;{</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <a class="code" href="class_vault_dir_iterator.html">VaultDirIterator</a>(<span class="keyword">const</span> <a class="code" href="class_d_url.html">DUrl</a> &amp;url,</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;                     <span class="keyword">const</span> QStringList &amp;nameFilters,</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;                     QDir::Filters filter,</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;                     QDirIterator::IteratorFlags flags = QDirIterator::NoIteratorFlags);</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    ~<a class="code" href="class_vault_dir_iterator.html">VaultDirIterator</a>() <span class="keyword">override</span>;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> next() <span class="keyword">override</span>;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordtype">bool</span> hasNext() <span class="keyword">const override</span>;</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    QString fileName() <span class="keyword">const override</span>;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> fileUrl() <span class="keyword">const override</span>;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="keyword">const</span> DAbstractFileInfoPointer fileInfo() <span class="keyword">const override</span>;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url() <span class="keyword">const override</span>;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="keyword">private</span>:</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    QDir::Filters filters;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    <a class="code" href="class_d_f_m_file_list_file.html">DFMFileListFile</a> *hiddenFiles = <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    QDirIterator *iterator;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    <span class="keywordtype">bool</span> nextIsCached = <span class="keyword">false</span>;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;};</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;VaultDirIterator::VaultDirIterator(<span class="keyword">const</span> <a class="code" href="class_d_url.html">DUrl</a> &amp;url, <span class="keyword">const</span> QStringList &amp;nameFilters,</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;                                   QDir::Filters filter, QDirIterator::IteratorFlags flags)</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    : <a class="code" href="class_d_dir_iterator.html">DDirIterator</a>()</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    , filters(filter)</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;{</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    QString path = VaultController::vaultToLocal(url);</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    iterator = <span class="keyword">new</span> QDirIterator(path, nameFilters, filter, flags);</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    hiddenFiles = <span class="keyword">new</span> <a class="code" href="class_d_f_m_file_list_file.html">DFMFileListFile</a>(path);</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;}</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;VaultDirIterator::~VaultDirIterator()</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;{</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="keywordflow">if</span> (iterator) {</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <span class="keyword">delete</span> iterator;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    }</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordflow">if</span> (hiddenFiles) {</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="keyword">delete</span> hiddenFiles;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    }</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;}</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<a class="code" href="class_d_url.html">DUrl</a> VaultDirIterator::next()</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;{</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    <span class="keywordflow">if</span> (nextIsCached) {</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        nextIsCached = <span class="keyword">false</span>;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        QString path = iterator-&gt;filePath();</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <a class="code" href="class_d_url.html">DUrl</a> url = VaultController::localToVault(path);</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        VaultController::ins()-&gt;updateFileInfo(<a class="code" href="class_q_list.html">DUrlList</a>() &lt;&lt; url);</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="keywordflow">return</span> url;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    }</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url = VaultController::localToVault(iterator-&gt;next());</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    VaultController::ins()-&gt;updateFileInfo(<a class="code" href="class_q_list.html">DUrlList</a>() &lt;&lt; url);</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    <span class="keywordflow">return</span> url;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;}</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">// 添加过滤，将保险箱中.hidden中记录的文件隐藏</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="keywordtype">bool</span> VaultDirIterator::hasNext()<span class="keyword"> const</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;    <span class="keywordflow">if</span> (nextIsCached) {</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    }</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="keywordtype">bool</span> hasNext = iterator-&gt;hasNext();</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keywordflow">if</span> (!hasNext) {</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    }</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordtype">bool</span> showHidden = filters.testFlag(QDir::Hidden);</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    DAbstractFileInfoPointer info;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;    <span class="keywordflow">do</span> {</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="keyword">const_cast&lt;</span><a class="code" href="class_vault_dir_iterator.html">VaultDirIterator</a> *<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;iterator-&gt;next();</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        QString absoluteFilePath = iterator-&gt;fileInfo().absoluteFilePath();</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        info = DAbstractFileInfoPointer(<span class="keyword">new</span> <a class="code" href="class_vault_file_info.html">VaultFileInfo</a>(DUrl::fromLocalFile(absoluteFilePath)));</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;        <span class="keywordflow">if</span> (!info-&gt;isPrivate() &amp;&amp; (showHidden || (!info-&gt;isHidden() &amp;&amp; !hiddenFiles-&gt;contains(info-&gt;fileName())))) {</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;        }</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        info.reset();</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    } <span class="keywordflow">while</span> (iterator-&gt;hasNext());</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="comment">// file is exists</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordflow">if</span> (info) {</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        <span class="keyword">const_cast&lt;</span><a class="code" href="class_vault_dir_iterator.html">VaultDirIterator</a> *<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;nextIsCached = <span class="keyword">true</span>;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    }</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    <span class="comment">//    return iterator-&gt;hasNext();</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;}</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;QString VaultDirIterator::fileName()<span class="keyword"> const</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keywordflow">return</span> iterator-&gt;fileName();</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;}</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<a class="code" href="class_d_url.html">DUrl</a> VaultDirIterator::fileUrl()<span class="keyword"> const</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <span class="keywordflow">return</span> VaultController::localToVault(iterator-&gt;filePath());</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;}</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="keyword">const</span> DAbstractFileInfoPointer VaultDirIterator::fileInfo()<span class="keyword"> const</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keywordflow">return</span> DFileService::instance()-&gt;createFileInfo(<span class="keyword">nullptr</span>, fileUrl());</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;}</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<a class="code" href="class_d_url.html">DUrl</a> VaultDirIterator::url()<span class="keyword"> const</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="keywordflow">return</span> fileUrl();</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;}</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div><div class="line"><a name="l00200"></a><span class="lineno"><a class="line" href="class_vault_controller.html#add45f1dbf93b72756db353bf7a782d50">  200</a></span>&#160;<a class="code" href="class_vault_controller.html#add45f1dbf93b72756db353bf7a782d50">VaultController::VaultController</a>(QObject *parent)</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    : <a class="code" href="class_d_abstract_file_controller.html">DAbstractFileController</a>(parent), d_ptr(new <a class="code" href="class_vault_controller_private.html">VaultControllerPrivate</a>(this))</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;{</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    Q_D(<a class="code" href="class_vault_controller.html">VaultController</a>);</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    DFMLogManager::getFilterAppender()-&gt;<a class="code" href="class_filter_appender.html#ad088cfbc3d5cf80f38d59eb7b19d19db">addFilter</a>(VAULT_DECRYPT_DIR_NAME);</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    d-&gt;m_cryFsHandle = <span class="keyword">new</span> <a class="code" href="class_cry_fs_handle.html">CryFsHandle</a>(<span class="keyword">this</span>);</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;    connect(<span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a4928d1f5723b957ca53dd313f6a6a04d">VaultController::sigCreateVault</a>, d-&gt;m_cryFsHandle, &amp;<a class="code" href="class_cry_fs_handle.html#ac3677f7b383527dda9138f7e73c90aa1">CryFsHandle::createVault</a>);</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    connect(<span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a639ee329872844d0452a7b7080a720f7">VaultController::sigUnlockVault</a>, d-&gt;m_cryFsHandle, &amp;<a class="code" href="class_cry_fs_handle.html#a55af2347d454125cacb8a2533a5db2e7">CryFsHandle::unlockVault</a>);</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    connect(<span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a1ab9aa68e6dea6a4b0098bc082cdaa2f">VaultController::sigLockVault</a>, d-&gt;m_cryFsHandle, &amp;<a class="code" href="class_cry_fs_handle.html#a39109e9312dfb471653589206e7465d6">CryFsHandle::lockVault</a>);</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;    <span class="comment">// 创建保险箱，关联信号</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    connect(d-&gt;m_cryFsHandle, &amp;<a class="code" href="class_cry_fs_handle.html#a4142b6f6ec015abb763bde4b6cea77c2">CryFsHandle::signalCreateVault</a>, <span class="keyword">this</span>, &amp;VaultController::slotCreateVault);</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    connect(d-&gt;m_cryFsHandle, &amp;<a class="code" href="class_cry_fs_handle.html#a5151929e494830356c84c73689249528">CryFsHandle::signalUnlockVault</a>, <span class="keyword">this</span>, &amp;VaultController::slotUnlockVault);</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    connect(d-&gt;m_cryFsHandle, &amp;<a class="code" href="class_cry_fs_handle.html#af6b251a9a56e20fbb3aef290dc7694b3">CryFsHandle::signalLockVault</a>, <span class="keyword">this</span>, &amp;VaultController::slotLockVault);</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    connect(d-&gt;m_cryFsHandle, &amp;<a class="code" href="class_cry_fs_handle.html#a38f5e500d5ecffb59b2816c8d42714a8">CryFsHandle::signalReadError</a>, <span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#ab33662db60d59b563219ecc6cbfa1861">VaultController::signalReadError</a>);</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    connect(d-&gt;m_cryFsHandle, &amp;<a class="code" href="class_cry_fs_handle.html#a4364984179e53728f25744589a540bdf">CryFsHandle::signalReadOutput</a>, <span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a9505834512bb967ccdc47edb3188d853">VaultController::signalReadOutput</a>);</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="comment">// Get root dir size.</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    m_sizeWorker = <span class="keyword">new</span> <a class="code" href="class_d_file_statistics_job.html">DFileStatisticsJob</a>(<span class="keyword">this</span>);</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> rootUrl = vaultToLocalUrl(makeVaultUrl());</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    m_sizeWorker-&gt;start({rootUrl});</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    connect(m_sizeWorker, &amp;DFileStatisticsJob::dataNotify, <span class="keyword">this</span>, &amp;VaultController::updateFolderSizeLabel);</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="comment">// Refresh size when lock state changed.</span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    connect(<span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#aaccf57d055f3f727aa585549c179b5bb">VaultController::signalUnlockVault</a>, <span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a842eb93e358a47228a84d03fdfe24fd7">VaultController::refreshTotalSize</a>);</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    connect(<span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a294d12400f0cf4e0adc7b591833d13f7">VaultController::signalLockVault</a>, <span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a842eb93e358a47228a84d03fdfe24fd7">VaultController::refreshTotalSize</a>);</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;    <span class="comment">// 保险箱大小计算线程结束后，再次计算一次大小</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    connect(m_sizeWorker, &amp;QThread::finished, <span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a2337b3c317a3a264fb72e558c49ef488">VaultController::onFinishCalcSize</a>);</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="comment">// 初始化时，记录保险箱状态</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    m_enVaultState = <a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>();</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;}</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<a class="code" href="class_vault_controller.html">VaultController</a> *VaultController::ins()</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;{</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="keywordflow">if</span> (!cryfs) {</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        <a class="code" href="class_d_url.html">DUrl</a> url(DFMVAULT_ROOT);</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        url.setScheme(DFMVAULT_SCHEME);</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <a class="code" href="class_q_list.html">QList&lt;DAbstractFileController *&gt;</a> vaultObjlist = DFileService::getHandlerTypeByUrl(url);</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        <span class="keywordflow">if</span> (vaultObjlist.size() &gt; 0)</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;            cryfs = static_cast&lt;VaultController *&gt;(vaultObjlist.first());</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    }</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="keywordflow">return</span> cryfs;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;}</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div><div class="line"><a name="l00251"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a402993d761fd9cc86d1d7b0ae8b5d1b7">  251</a></span>&#160;<span class="keyword">const</span> DAbstractFileInfoPointer <a class="code" href="class_vault_controller.html#a402993d761fd9cc86d1d7b0ae8b5d1b7">VaultController::createFileInfo</a>(<span class="keyword">const</span> QSharedPointer&lt;DFMCreateFileInfoEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url(makeVaultUrl());</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="keywordflow">if</span> (url == event-&gt;url()) {</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="keywordflow">return</span> DAbstractFileInfoPointer(<span class="keyword">new</span> <a class="code" href="class_vault_file_info.html">VaultFileInfo</a>(makeVaultUrl(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>())));</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    }</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    url = <span class="keyword">event</span>-&gt;url();</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    QString localFile = url.toLocalFile();</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    QFileInfo info(localFile);</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">if</span> (!info.isSymLink() &amp;&amp; FileUtils::isDesktopFile(localFile)) {</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;        <span class="keywordflow">return</span> DAbstractFileInfoPointer(<span class="keyword">new</span> <a class="code" href="class_desktop_file_info.html">DesktopFileInfo</a>(event-&gt;url()));</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    }</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="keyword">const_cast&lt;</span><a class="code" href="class_vault_controller.html">VaultController</a> *<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;updateFileInfo(<a class="code" href="class_q_list.html">DUrlList</a>() &lt;&lt; <span class="keyword">event</span>-&gt;url());</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="keywordflow">return</span> DAbstractFileInfoPointer(<span class="keyword">new</span> <a class="code" href="class_vault_file_info.html">VaultFileInfo</a>(event-&gt;url()));</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;}</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="keyword">const</span> DDirIteratorPointer VaultController::createDirIterator(<span class="keyword">const</span> QSharedPointer&lt;DFMCreateDiriterator&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url = <span class="keyword">event</span>-&gt;url();</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    <span class="keywordflow">if</span> (event-&gt;url() == makeVaultUrl()) {</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;        url = makeVaultUrl(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>());</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    }</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="keywordflow">return</span> DDirIteratorPointer(<span class="keyword">new</span> <a class="code" href="class_vault_dir_iterator.html">VaultDirIterator</a>(url, event-&gt;nameFilters(), <span class="keyword">event</span>-&gt;filters(), <span class="keyword">event</span>-&gt;flags()));</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;}</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<a class="code" href="class_d_abstract_file_watcher.html">DAbstractFileWatcher</a> *VaultController::createFileWatcher(<span class="keyword">const</span> QSharedPointer&lt;DFMCreateFileWatcherEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    QString urlPath = <span class="keyword">event</span>-&gt;url().toLocalFile();</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="keywordflow">if</span> (urlPath.isEmpty()) <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url = makeVaultUrl(urlPath);</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keyword">auto</span> watcher = <span class="keyword">new</span> <a class="code" href="class_d_file_proxy_watcher.html">DFileProxyWatcher</a>(url,</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;                                         <span class="keyword">new</span> <a class="code" href="class_d_file_watcher.html">DFileWatcher</a>(urlPath),</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;                                         VaultController::localUrlToVault);</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    connect(watcher, &amp;DFileProxyWatcher::fileDeleted, <span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a842eb93e358a47228a84d03fdfe24fd7">VaultController::refreshTotalSize</a>);</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    connect(watcher, &amp;DFileProxyWatcher::subfileCreated, <span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a842eb93e358a47228a84d03fdfe24fd7">VaultController::refreshTotalSize</a>);</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    connect(watcher, &amp;DFileProxyWatcher::fileMoved, <span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a842eb93e358a47228a84d03fdfe24fd7">VaultController::refreshTotalSize</a>);</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    connect(watcher, &amp;DFileProxyWatcher::fileAttributeChanged, <span class="keyword">this</span>, &amp;<a class="code" href="class_vault_controller.html#a842eb93e358a47228a84d03fdfe24fd7">VaultController::refreshTotalSize</a>);</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="keywordflow">return</span> watcher;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;}</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="keywordtype">bool</span> VaultController::openFile(<span class="keyword">const</span> QSharedPointer&lt;DFMOpenFileEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;    <span class="keywordflow">return</span> DFileService::instance()-&gt;openFile(event-&gt;sender(), vaultToLocalUrl(event-&gt;url()));</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;}</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="keywordtype">bool</span> VaultController::openFiles(<span class="keyword">const</span> QSharedPointer&lt;DFMOpenFilesEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    <span class="comment">//    return DFileService::instance()-&gt;openFiles(event-&gt;sender(), vaultToLocalUrls(event-&gt;urlList()));</span></div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    <a class="code" href="class_q_list.html">DUrlList</a> fileUrls = <span class="keyword">event</span>-&gt;urlList();</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <a class="code" href="class_q_list.html">DUrlList</a> packUrl;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    QStringList pathList;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    <span class="keywordtype">bool</span> result = <span class="keyword">false</span>;</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    <span class="keywordflow">for</span> (<a class="code" href="class_d_url.html">DUrl</a> fileUrl : fileUrls) {</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        <span class="keyword">const</span> DAbstractFileInfoPointer pfile = <a class="code" href="class_vault_controller.html#a402993d761fd9cc86d1d7b0ae8b5d1b7">createFileInfo</a>(dMakeEventPointer&lt;DFMCreateFileInfoEvent&gt;(<span class="keyword">this</span>, fileUrl));</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;        <span class="keywordflow">if</span> (pfile-&gt;isSymLink()) {</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;            <span class="keyword">const</span> DAbstractFileInfoPointer &amp;linkInfo = DFileService::instance()-&gt;createFileInfo(<span class="keyword">this</span>, pfile-&gt;symLinkTarget());</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;            <span class="keywordflow">if</span> (linkInfo &amp;&amp; !linkInfo-&gt;exists()) {</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                dialogManager-&gt;showBreakSymlinkDialog(linkInfo-&gt;fileName(), fileUrl);</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;            }</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            fileUrl = linkInfo-&gt;redirectedFileUrl();</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        }</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;        <span class="keywordflow">if</span> (FileUtils::isExecutableScript(fileUrl.toLocalFile())) {</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;            <span class="keywordtype">int</span> code = dialogManager-&gt;showRunExcutableScriptDialog(fileUrl, event-&gt;windowId());</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;            result = FileUtils::openExcutableScriptFile(fileUrl.toLocalFile(), code) || result;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        }</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        <span class="keywordflow">if</span> (FileUtils::isFileRunnable(fileUrl.toLocalFile()) &amp;&amp; !pfile-&gt;isDesktopFile()) {</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;            <span class="keywordtype">int</span> code = dialogManager-&gt;showRunExcutableFileDialog(fileUrl, event-&gt;windowId());</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;            result = FileUtils::openExcutableFile(fileUrl.toLocalFile(), code) || result;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;        }</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;        <span class="keywordflow">if</span> (FileUtils::shouldAskUserToAddExecutableFlag(fileUrl.toLocalFile()) &amp;&amp; !pfile-&gt;isDesktopFile()) {</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;            <span class="keywordtype">int</span> code = dialogManager-&gt;showAskIfAddExcutableFlagAndRunDialog(fileUrl, event-&gt;windowId());</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;            result = FileUtils::addExecutableFlagAndExecuse(fileUrl.toLocalFile(), code) || result;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;            <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        }</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;        packUrl &lt;&lt; fileUrl;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        QString url = vaultToLocal(fileUrl);</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        <span class="keywordflow">if</span> (FileUtils::isFileWindowsUrlShortcut(url)) {</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;            url = FileUtils::getInternetShortcutUrl(url);</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        }</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        pathList &lt;&lt; url;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    }</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    <span class="keywordflow">if</span> (!pathList.empty()) {</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        <span class="keywordflow">if</span> (event-&gt;isEnter()) {</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;            result = FileUtils::openEnterFiles(pathList);</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;            result = FileUtils::openFiles(pathList);</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        }</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        <span class="keywordflow">if</span> (!result) {</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">const</span> <a class="code" href="class_d_url.html">DUrl</a> &amp;fileUrl : packUrl) {</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;                AppController::instance()-&gt;actionOpenWithCustom(dMakeEventPointer&lt;DFMOpenFileEvent&gt;(event-&gt;sender(), fileUrl)); <span class="comment">// requestShowOpenWithDialog</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;            }</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        }</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    }</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    <span class="keywordflow">return</span> result;</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;}</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="keywordtype">bool</span> VaultController::openFileByApp(<span class="keyword">const</span> QSharedPointer&lt;DFMOpenFileByAppEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="comment">//处理快捷方式，还原成原路径</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> fileUrl = <span class="keyword">event</span>-&gt;url();</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    <span class="keyword">const</span> DAbstractFileInfoPointer pfile = <a class="code" href="class_vault_controller.html#a402993d761fd9cc86d1d7b0ae8b5d1b7">createFileInfo</a>(dMakeEventPointer&lt;DFMCreateFileInfoEvent&gt;(<span class="keyword">this</span>, fileUrl));</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    <span class="keywordflow">if</span> (pfile-&gt;isSymLink()) {</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;        <span class="keyword">const</span> DAbstractFileInfoPointer &amp;linkInfo = DFileService::instance()-&gt;createFileInfo(<span class="keyword">this</span>, pfile-&gt;symLinkTarget());</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        <span class="keywordflow">if</span> (linkInfo &amp;&amp; !linkInfo-&gt;exists()) {</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            dialogManager-&gt;showBreakSymlinkDialog(linkInfo-&gt;fileName(), fileUrl);</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;        }</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;        <span class="keyword">const_cast&lt;</span><a class="code" href="class_d_url.html">DUrl</a> &amp;<span class="keyword">&gt;</span>(fileUrl) = linkInfo-&gt;redirectedFileUrl();</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    }</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    <span class="keywordflow">return</span> DFileService::instance()-&gt;openFileByApp(event-&gt;sender(), <span class="keyword">event</span>-&gt;appName(), vaultToLocalUrl(fileUrl));</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;}</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="keywordtype">bool</span> VaultController::openFilesByApp(<span class="keyword">const</span> QSharedPointer&lt;DFMOpenFilesByAppEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    <span class="comment">//处理快捷方式，还原成原路径</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    <a class="code" href="class_q_list.html">QList&lt;DUrl&gt;</a> fileUrls = <span class="keyword">event</span>-&gt;urlList();</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    QStringList pathList;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    <span class="keywordflow">for</span> (<a class="code" href="class_d_url.html">DUrl</a> fileUrl : fileUrls) {</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;        <span class="keyword">const</span> DAbstractFileInfoPointer pfile = <a class="code" href="class_vault_controller.html#a402993d761fd9cc86d1d7b0ae8b5d1b7">createFileInfo</a>(dMakeEventPointer&lt;DFMCreateFileInfoEvent&gt;(<span class="keyword">this</span>, fileUrl));</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;        <span class="keywordflow">if</span> (pfile-&gt;isSymLink()) {</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            <span class="keyword">const</span> DAbstractFileInfoPointer &amp;linkInfo = DFileService::instance()-&gt;createFileInfo(<span class="keyword">this</span>, pfile-&gt;symLinkTarget());</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;            <span class="keywordflow">if</span> (linkInfo &amp;&amp; !linkInfo-&gt;exists()) {</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                dialogManager-&gt;showBreakSymlinkDialog(linkInfo-&gt;fileName(), fileUrl);</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                <span class="keywordflow">continue</span>;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;            }</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;            fileUrl = linkInfo-&gt;redirectedFileUrl();</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;        }</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        QString url = fileUrl.toLocalFile();</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;        <span class="keywordflow">if</span> (FileUtils::isFileWindowsUrlShortcut(url)) {</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;            url = FileUtils::getInternetShortcutUrl(url);</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;        }</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;        pathList &lt;&lt; url;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    }</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordflow">return</span> FileUtils::openFilesByApp(event-&gt;appName(), pathList);</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;}</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="keywordtype">bool</span> VaultController::deleteFiles(<span class="keyword">const</span> QSharedPointer&lt;DFMDeleteEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    <a class="code" href="class_q_list.html">DUrlList</a> urlList = vaultToLocalUrls(event-&gt;urlList());</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="keywordtype">bool</span> bDeletedSuccess = DFileService::instance()-&gt;deleteFiles(event-&gt;sender(), urlList);</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="keywordflow">if</span> (bDeletedSuccess) {</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;        <span class="keyword">const_cast&lt;</span><a class="code" href="class_vault_controller.html">VaultController</a> *<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;updateFileInfo(urlList);</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;        emit <span class="keyword">const_cast&lt;</span><a class="code" href="class_vault_controller.html">VaultController</a> *<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;<a class="code" href="class_vault_controller.html#ac53b08b43f3169a10529f45b94d8394c">signalFileDeleted</a>();</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    }</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    m_isBigFileDeleting = <span class="keyword">false</span>;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;}</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;<a class="code" href="class_q_list.html">DUrlList</a> VaultController::moveToTrash(<span class="keyword">const</span> QSharedPointer&lt;DFMMoveToTrashEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <a class="code" href="class_q_list.html">DUrlList</a> urlList = vaultToLocalUrls(event-&gt;urlList());</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;    <span class="keywordtype">bool</span> bDeletedSuccess = DFileService::instance()-&gt;deleteFiles(event-&gt;sender(), urlList);</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    <span class="keywordflow">if</span> (bDeletedSuccess) {</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        <span class="keyword">const_cast&lt;</span><a class="code" href="class_vault_controller.html">VaultController</a> *<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;updateFileInfo(urlList);</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        emit <span class="keyword">const_cast&lt;</span><a class="code" href="class_vault_controller.html">VaultController</a> *<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;<a class="code" href="class_vault_controller.html#ac53b08b43f3169a10529f45b94d8394c">signalFileDeleted</a>();</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    }</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    m_isBigFileDeleting = <span class="keyword">false</span>;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;    <span class="keywordflow">return</span> urlList;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;}</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<a class="code" href="class_q_list.html">DUrlList</a> VaultController::pasteFile(<span class="keyword">const</span> QSharedPointer&lt;DFMPasteEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    <a class="code" href="class_q_list.html">DUrlList</a> urlList = vaultToLocalUrls(event-&gt;urlList());</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url = vaultToLocalUrl(event-&gt;targetUrl());</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    <a class="code" href="class_q_list.html">DUrlList</a> ulist = DFileService::instance()-&gt;pasteFile(event-&gt;sender(), <span class="keyword">event</span>-&gt;action(), url, urlList);</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <span class="keywordflow">return</span> ulist;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;}</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="keywordtype">bool</span> VaultController::writeFilesToClipboard(<span class="keyword">const</span> QSharedPointer&lt;DFMWriteUrlsToClipboardEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    <a class="code" href="class_q_list.html">DUrlList</a> urlList = vaultToLocalUrls(event-&gt;urlList());</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;    <span class="keywordflow">return</span> DFileService::instance()-&gt;writeFilesToClipboard(event-&gt;sender(), <span class="keyword">event</span>-&gt;action(), urlList);</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;}</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="keywordtype">bool</span> VaultController::renameFile(<span class="keyword">const</span> QSharedPointer&lt;DFMRenameEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    <span class="keywordtype">bool</span> flg = DFileService::instance()-&gt;renameFile(event-&gt;sender(),</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                                                    vaultToLocalUrl(event-&gt;fromUrl()),</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;                                                    vaultToLocalUrl(event-&gt;toUrl()));</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    <span class="keywordflow">if</span> (flg) {</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        <span class="keyword">const_cast&lt;</span><a class="code" href="class_vault_controller.html">VaultController</a> *<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;updateFileInfo(<a class="code" href="class_q_list.html">DUrlList</a>() &lt;&lt; <span class="keyword">event</span>-&gt;fromUrl());</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    }</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="keywordflow">return</span> flg;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;}</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div><div class="line"><a name="l00466"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a39c59f624991247ec4afea13b83b9d63">  466</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#a39c59f624991247ec4afea13b83b9d63">VaultController::shareFolder</a>(<span class="keyword">const</span> QSharedPointer&lt;DFMFileShareEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <a class="code" href="class_share_info.html">ShareInfo</a> info;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    info.setPath(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(event-&gt;name()));</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    info.setShareName(event-&gt;name());</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    info.setIsGuestOk(event-&gt;allowGuest());</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    info.setIsWritable(event-&gt;isWritable());</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keywordtype">bool</span> ret = userShareManager-&gt;addUserShare(info);</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;}</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div><div class="line"><a name="l00480"></a><span class="lineno"><a class="line" href="class_vault_controller.html#ac56878a5fe44d21fbb918db40d8c1609">  480</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#ac56878a5fe44d21fbb918db40d8c1609">VaultController::unShareFolder</a>(<span class="keyword">const</span> QSharedPointer&lt;DFMCancelFileShareEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    QString path = vaultToLocalUrl(event-&gt;fileUrl()).path();</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    userShareManager-&gt;deleteUserShareByPath(path);</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;}</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;</div><div class="line"><a name="l00488"></a><span class="lineno"><a class="line" href="class_vault_controller.html#abffd69b376a26d943d859afb91a395ec">  488</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#abffd69b376a26d943d859afb91a395ec">VaultController::openInTerminal</a>(<span class="keyword">const</span> QSharedPointer&lt;DFMOpenInTerminalEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="keyword">const</span> QString &amp;current_dir = QDir::currentPath();</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    QDir::setCurrent(vaultToLocalUrl(event-&gt;url()).toLocalFile());</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    <span class="keywordtype">bool</span> ok = QProcess::startDetached(FileUtils::defaultTerminalPath());</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    QDir::setCurrent(current_dir);</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="keywordflow">return</span> ok;</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;}</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div><div class="line"><a name="l00501"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a7a3ffffcf3deb249f00f7f4625d59ed6">  501</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#a7a3ffffcf3deb249f00f7f4625d59ed6">VaultController::addToBookmark</a>(<span class="keyword">const</span> QSharedPointer&lt;DFMAddToBookmarkEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> destUrl = <span class="keyword">event</span>-&gt;url();</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    <span class="keyword">const</span> DAbstractFileInfoPointer &amp;p = fileService-&gt;createFileInfo(<span class="keyword">nullptr</span>, destUrl);</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> bookmarkUrl = DUrl::fromBookMarkFile(destUrl, p-&gt;fileDisplayName());</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    <a class="code" href="class_d_storage_info.html">DStorageInfo</a> info(destUrl.path());</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    QString filePath = destUrl.path();</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    QString rootPath = info.rootPath();</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="keywordflow">if</span> (rootPath != QStringLiteral(<span class="stringliteral">&quot;/&quot;</span>) || rootPath != QStringLiteral(<span class="stringliteral">&quot;/home&quot;</span>)) {</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        QString devStr = info.device();</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;        QString locateUrl;</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        <span class="keywordtype">int</span> endPos = filePath.indexOf(rootPath);</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;        <span class="keywordflow">if</span> (endPos != -1) {</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;            endPos += rootPath.length();</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;            locateUrl = filePath.mid(endPos);</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        }</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;        <span class="keywordflow">if</span> (devStr.startsWith(QStringLiteral(<span class="stringliteral">&quot;/dev/&quot;</span>))) {</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;            devStr = DUrl::fromDeviceId(info.device()).toString();</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;        }</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        QUrlQuery query;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;        query.addQueryItem(<span class="stringliteral">&quot;mount_point&quot;</span>, devStr);</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;        query.addQueryItem(<span class="stringliteral">&quot;locate_url&quot;</span>, locateUrl);</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;        bookmarkUrl.setQuery(query);</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    }</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;    <span class="keywordflow">return</span> DFileService::instance()-&gt;touchFile(event-&gt;sender(), bookmarkUrl);</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;}</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div><div class="line"><a name="l00531"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a2d4d431c25403b6d04e9ec4817f67281">  531</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#a2d4d431c25403b6d04e9ec4817f67281">VaultController::removeBookmark</a>(<span class="keyword">const</span> QSharedPointer&lt;DFMRemoveBookmarkEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;    <span class="keywordflow">return</span> DFileService::instance()-&gt;deleteFiles(<span class="keyword">nullptr</span>, {DUrl::fromBookMarkFile(event-&gt;url(), QString())}, <span class="keyword">false</span>);</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;}</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a396bef84d7f2fcb0a51c5b0930451d8b">  536</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#a396bef84d7f2fcb0a51c5b0930451d8b">VaultController::createSymlink</a>(<span class="keyword">const</span> QSharedPointer&lt;DFMCreateSymlinkEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    QString path = vaultToLocalUrl(event-&gt;fileUrl()).path();</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    QFile file(path);</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    QUrl url = <span class="keyword">event</span>-&gt;toUrl().toLocalFile();</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keywordtype">bool</span> ok = file.link(event-&gt;toUrl().toLocalFile());</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    <span class="keywordflow">if</span> (ok) {</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    }</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="keywordflow">if</span> (event-&gt;force()) {</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;        <span class="comment">// replace symlink, remove if target was existed</span></div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        QFileInfo toLink(event-&gt;toUrl().toLocalFile());</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;        <span class="keywordflow">if</span> (toLink.isSymLink() || toLink.exists()) {</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;            QFile::remove(event-&gt;toUrl().toLocalFile());</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;        }</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    }</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="keywordtype">int</span> code = ::symlink(event-&gt;fileUrl().toLocalFile().toLocal8Bit().constData(),</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;                         <span class="keyword">event</span>-&gt;toUrl().toLocalFile().toLocal8Bit().constData());</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <span class="keywordflow">if</span> (code == -1) {</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;        ok = <span class="keyword">false</span>;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        QString errorString = strerror(errno);</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;        dialogManager-&gt;showFailToCreateSymlinkDialog(errorString);</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;        ok = <span class="keyword">true</span>;</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    }</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    <span class="keywordflow">return</span> ok;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;}</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a8580d427cdd9bd9ea9040c1a58415227">  570</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#a8580d427cdd9bd9ea9040c1a58415227">VaultController::setFileTags</a>(<span class="keyword">const</span> QSharedPointer&lt;DFMSetFileTagsEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url = <span class="keyword">event</span>-&gt;url();</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> durl = vaultToLocalUrl(url);</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;    <a class="code" href="class_q_list.html">QList&lt;QString&gt;</a> taglist = <span class="keyword">event</span>-&gt;tags();</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="keywordflow">if</span> (taglist.isEmpty()) {</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        <span class="keyword">const</span> QStringList &amp;tags = TagManager::instance()-&gt;getTagsThroughFiles({durl});</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;        <span class="keywordflow">return</span> tags.isEmpty() || TagManager::instance()-&gt;removeTagsOfFiles(tags, {durl});</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;    }</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    <span class="keywordflow">return</span> TagManager::instance()-&gt;<a class="code" href="class_tag_manager.html#a5354f94aa3f655a55e52c0dcf1b1e84c">makeFilesTags</a>(taglist, {durl});</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;}</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;</div><div class="line"><a name="l00584"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a7c96f61313ec6313632089a0e38a7a3f">  584</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#a7c96f61313ec6313632089a0e38a7a3f">VaultController::removeTagsOfFile</a>(<span class="keyword">const</span> QSharedPointer&lt;DFMRemoveTagsOfFileEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url = <span class="keyword">event</span>-&gt;url();</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> durl = vaultToLocalUrl(url);</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;    <a class="code" href="class_q_list.html">QList&lt;QString&gt;</a> taglist = <span class="keyword">event</span>-&gt;tags();</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;    <span class="keywordflow">return</span> TagManager::instance()-&gt;removeTagsOfFiles(taglist, {durl});</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;}</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;</div><div class="line"><a name="l00592"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a196157fb914802a63c1cc57a36bc6cc9">  592</a></span>&#160;<a class="code" href="class_q_list.html">QList&lt;QString&gt;</a> <a class="code" href="class_vault_controller.html#a196157fb914802a63c1cc57a36bc6cc9">VaultController::getTagsThroughFiles</a>(<span class="keyword">const</span> QSharedPointer&lt;DFMGetTagsThroughFilesEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;    <a class="code" href="class_q_list.html">DUrlList</a> urllist = <span class="keyword">event</span>-&gt;urlList();</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    <a class="code" href="class_q_list.html">DUrlList</a> tempList = vaultToLocalUrls(urllist);</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    <span class="keywordflow">return</span> TagManager::instance()-&gt;getTagsThroughFiles(tempList);</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;}</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="keywordtype">bool</span> VaultController::setPermissions(<span class="keyword">const</span> QSharedPointer&lt;DFMSetPermissionEvent&gt; &amp;event)<span class="keyword"> const</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url = <span class="keyword">event</span>-&gt;url();</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> durl = vaultToLocalUrl(url);</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="keywordtype">bool</span> flg = DFileService::instance()-&gt;setPermissions(event-&gt;sender(), durl, <span class="keyword">event</span>-&gt;permissions());</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    <span class="keywordflow">if</span> (flg) {</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;        <span class="keyword">const_cast&lt;</span><a class="code" href="class_vault_controller.html">VaultController</a> *<span class="keyword">&gt;</span>(<span class="keyword">this</span>)-&gt;updateFileInfo(<a class="code" href="class_q_list.html">DUrlList</a>() &lt;&lt; url);</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;    }</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="keywordflow">return</span> flg;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;}</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="keywordtype">void</span> VaultController::updateFileInfo(<span class="keyword">const</span> <a class="code" href="class_q_list.html">DUrlList</a> &amp;fileUrls)</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;{</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    <span class="keyword">static</span> QMutex mutex;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;    mutex.lock();</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;    <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;url : fileUrls) {</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        QFileInfo fileInfo(url.path());</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        <span class="keywordflow">if</span> (!fileInfo.exists()) {</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;            m_mapVaultFileInfo.remove(url);</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;            <span class="comment">//当文件删除时，删除隐藏文件集中的隐藏</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;            QString absort = url.path().left(url.path().length() - url.fileName().length());</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;            <a class="code" href="class_d_f_m_file_list_file.html">DFMFileListFile</a> flf(absort);</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;            <span class="keywordflow">if</span> (flf.contains(url.fileName())) {</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;                flf.remove(url.fileName());</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;                flf.<a class="code" href="class_d_f_m_file_list_file.html#aae6d9de3223f561add9b3350aa3d948b">save</a>();</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;            }</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;            <span class="keywordflow">if</span> (!m_mapVaultFileInfo.contains(url)) {</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                <a class="code" href="struct_vault_controller_1_1_file_base_info.html">FileBaseInfo</a> fbi;</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                fbi.isExist = <span class="keyword">true</span>;</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                fbi.isDir = fileInfo.isDir();</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                fbi.isFile = fileInfo.isFile();</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                fbi.isSymLink = fileInfo.isSymLink();</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;                <span class="comment">// 使用stat判断文件是否可写，因为QFileInfo获取到的不正确</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;                QT_STATBUF statBuffer;</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;                <span class="keywordflow">if</span> (QT_STAT(QFile::encodeName(url.path()), &amp;statBuffer) == 0) {</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                    <span class="keywordflow">if</span> (!(statBuffer.st_mode &amp; S_IWUSR)) {</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                        fbi.isWritable = <span class="keyword">false</span>;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                        fbi.isWritable = <span class="keyword">true</span>;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                    }</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                }</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                m_mapVaultFileInfo.insert(url, fbi);</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                m_mapVaultFileInfo[url].isDir = fileInfo.isDir();</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                m_mapVaultFileInfo[url].isFile = fileInfo.isFile();</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                m_mapVaultFileInfo[url].isSymLink = fileInfo.isSymLink();</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                QT_STATBUF statBuffer;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                <span class="keywordflow">if</span> (QT_STAT(QFile::encodeName(url.path()), &amp;statBuffer) == 0) {</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                    <span class="keywordflow">if</span> (!(statBuffer.st_mode &amp; S_IWUSR)) {</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                        m_mapVaultFileInfo[url].isWritable = <span class="keyword">false</span>;</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                        m_mapVaultFileInfo[url].isWritable = <span class="keyword">true</span>;</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                    }</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                }</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;            }</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        }</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    }</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    mutex.unlock();</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;}</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<a class="code" href="struct_vault_controller_1_1_file_base_info.html">VaultController::FileBaseInfo</a> VaultController::getFileInfo(<span class="keyword">const</span> <a class="code" href="class_d_url.html">DUrl</a> &amp;fileUrl)</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;{</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;    <span class="keywordflow">if</span> (m_mapVaultFileInfo.contains(fileUrl)) {</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        <span class="keywordflow">return</span> m_mapVaultFileInfo[fileUrl];</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    }</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="struct_vault_controller_1_1_file_base_info.html">FileBaseInfo</a>();</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;}</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<a class="code" href="class_d_url.html">DUrl</a> VaultController::makeVaultUrl(QString path, QString host)</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;{</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    Q_UNUSED(host)</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="comment">// blumia: if path is not start with a `/`, QUrl::setPath will destory the whole QUrl</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    <span class="comment">//         and only leave the path to the QUrl.</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    <span class="keywordflow">if</span> (!path.startsWith(<span class="charliteral">&#39;/&#39;</span>)) {</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        path = <span class="charliteral">&#39;/&#39;</span> + path;</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    }</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> newUrl;</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    newUrl.setScheme(DFMVAULT_SCHEME);</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    newUrl.setHost(host);</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    newUrl.setPath(path);</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    <span class="keywordflow">return</span> newUrl;</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;}</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<a class="code" href="class_d_url.html">DUrl</a> VaultController::localUrlToVault(<span class="keyword">const</span> <a class="code" href="class_d_url.html">DUrl</a> &amp;vaultUrl)</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;{</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;    <span class="keywordflow">return</span> VaultController::localToVault(vaultUrl.path());</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;}</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<a class="code" href="class_d_url.html">DUrl</a> VaultController::localToVault(QString localPath)</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;{</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="class_vault_controller.html#a0d01b851bcd3d96d87b1330cd7274ec5">isVaultFile</a>(localPath)) {</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        <span class="keywordflow">return</span> VaultController::makeVaultUrl(localPath);</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="class_d_url.html">DUrl</a>();</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    }</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;}</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;QString VaultController::vaultToLocal(<span class="keyword">const</span> <a class="code" href="class_d_url.html">DUrl</a> &amp;vaultUrl)</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;{</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    <span class="keywordflow">if</span> (vaultUrl.scheme() == DFMVAULT_SCHEME) {</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;        <span class="keywordflow">if</span> (vaultUrl == makeVaultUrl(<span class="stringliteral">&quot;/&quot;</span>))</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(vaultUrl.path());</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        <span class="keywordflow">else</span> {</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;            <span class="keywordflow">return</span> vaultUrl.toLocalFile();</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;        }</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    }</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    <span class="keywordflow">return</span> vaultUrl.toLocalFile();</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;}</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<a class="code" href="class_d_url.html">DUrl</a> VaultController::vaultToLocalUrl(<span class="keyword">const</span> <a class="code" href="class_d_url.html">DUrl</a> &amp;vaultUrl)</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;{</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;    <span class="keywordflow">if</span> (vaultUrl.scheme() != DFMVAULT_SCHEME) <span class="keywordflow">return</span> vaultUrl;</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    <span class="keywordflow">return</span> DUrl::fromLocalFile(vaultToLocal(vaultUrl));</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;}</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<a class="code" href="class_q_list.html">DUrlList</a> VaultController::vaultToLocalUrls(<a class="code" href="class_q_list.html">DUrlList</a> vaultUrls)</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;{</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    <span class="keywordflow">for</span> (<a class="code" href="class_d_url.html">DUrl</a> &amp;url : vaultUrls) {</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        url = vaultToLocalUrl(url);</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    }</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordflow">return</span> vaultUrls;</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;}</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;</div><div class="line"><a name="l00731"></a><span class="lineno"><a class="line" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">  731</a></span>&#160;VaultController::VaultState <a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">VaultController::state</a>(QString lockBaseDir)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;{</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    QString cryfsBinary = QStandardPaths::findExecutable(<span class="stringliteral">&quot;cryfs&quot;</span>);</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keywordflow">if</span> (cryfsBinary.isEmpty()) {</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        <span class="keywordflow">return</span> NotAvailable;</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    }</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    <span class="keywordflow">if</span> (lockBaseDir.isEmpty()) {</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;        lockBaseDir = <a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;cryfs.config&quot;</span>, VAULT_ENCRYPY_DIR_NAME);</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;        <span class="keywordflow">if</span> (lockBaseDir.endsWith(<span class="stringliteral">&quot;/&quot;</span>))</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;            lockBaseDir += <span class="stringliteral">&quot;cryfs.config&quot;</span>;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;            lockBaseDir += <span class="stringliteral">&quot;/cryfs.config&quot;</span>;</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    }</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    <span class="keywordflow">if</span> (QFile::exists(lockBaseDir)) {</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;        QStorageInfo info(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>));</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;        QString temp = info.fileSystemType();</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;        <span class="keywordflow">if</span> (info.isValid() &amp;&amp; temp == <span class="stringliteral">&quot;fuse.cryfs&quot;</span>) {</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;            <span class="keywordflow">return</span> Unlocked;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;        }</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;        <span class="keywordflow">return</span> Encrypted;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;        <span class="keywordflow">return</span> NotExisted;</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    }</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;}</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;</div><div class="line"><a name="l00759"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a755c637695ee3e91c82086278f96e166">  759</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#a755c637695ee3e91c82086278f96e166">VaultController::isRootDirectory</a>(QString path)</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;{</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    <span class="keywordtype">bool</span> bRootDir = <span class="keyword">false</span>;</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    QString localFilePath = <a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>();</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    QString pathNoSplash = localFilePath;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    pathNoSplash.chop(1);</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <span class="keywordflow">if</span> (localFilePath == path || makeVaultUrl().toString() == path</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;            || pathNoSplash == path) {</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;        bRootDir = <span class="keyword">true</span>;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    }</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    <span class="keywordflow">return</span> bRootDir;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;}</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;</div><div class="line"><a name="l00772"></a><span class="lineno"><a class="line" href="class_vault_controller.html#ab9f92856da6290e1d8909c755111427e">  772</a></span>&#160;QString <a class="code" href="class_vault_controller.html#ab9f92856da6290e1d8909c755111427e">VaultController::getErrorInfo</a>(<span class="keywordtype">int</span> <a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>)</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;{</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    QString strErr(<span class="stringliteral">&quot;&quot;</span>);</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    <span class="keywordflow">switch</span> (state) {</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <span class="keywordflow">case</span> 10:</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;        strErr = <span class="stringliteral">&quot;The command line arguments are invalid.&quot;</span>;</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    <span class="keywordflow">case</span> 11:</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;        strErr = <span class="stringliteral">&quot;Couldn&#39;t load config file. Probably the password is wrong&quot;</span>;</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="keywordflow">case</span> 12:</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;        strErr = <span class="stringliteral">&quot;Password cannot be empty&quot;</span>;</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="keywordflow">case</span> 13:</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        strErr = <span class="stringliteral">&quot;The file system format is too new for this CryFS version. Please update your CryFS version.&quot;</span>;</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;    <span class="keywordflow">case</span> 14:</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        strErr = <span class="stringliteral">&quot;The file system format is too old for this CryFS version. Run with --allow-filesystem-upgrade to upgrade it.&quot;</span>;</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    <span class="keywordflow">case</span> 15:</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        strErr = <span class="stringliteral">&quot;The file system uses a different cipher than the one specified on the command line using the --cipher argument.&quot;</span>;</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="keywordflow">case</span> 16:</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        strErr = <span class="stringliteral">&quot;Base directory doesn&#39;t exist or is inaccessible (i.e. not read or writable or not a directory)&quot;</span>;</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="keywordflow">case</span> 17:</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        strErr = <span class="stringliteral">&quot;Mount directory doesn&#39;t exist or is inaccessible (i.e. not read or writable or not a directory)&quot;</span>;</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="keywordflow">case</span> 18:</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        strErr = <span class="stringliteral">&quot;Base directory can&#39;t be a subdirectory of the mount directory&quot;</span>;</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;    <span class="keywordflow">case</span> 19:</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;        strErr = <span class="stringliteral">&quot;Something&#39;s wrong with the file system.&quot;</span>;</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;    <span class="keywordflow">case</span> 20:</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        strErr = <span class="stringliteral">&quot;The filesystem id in the config file is different to the last time we loaded a filesystem from this basedir. This could mean an attacker replaced the file system with a different one. You can pass the --allow-replaced-filesystem option to allow this.&quot;</span>;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    <span class="keywordflow">case</span> 21:</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;        strErr = <span class="stringliteral">&quot;The filesystem encryption key differs from the last time we loaded this filesystem. This could mean an attacker replaced the file system with a different one. You can pass the --allow-replaced-filesystem option to allow this.&quot;</span>;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;    <span class="keywordflow">case</span> 22:</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        strErr = <span class="stringliteral">&quot;The command line options and the file system disagree on whether missing blocks should be treated as integrity violations.&quot;</span>;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    <span class="keywordflow">case</span> 23:</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        strErr = <span class="stringliteral">&quot;File system is in single-client mode and can only be used from the client that created it.&quot;</span>;</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <span class="keywordflow">case</span> 24:</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;        strErr = <span class="stringliteral">&quot;A previous run of the file system detected an integrity violation. Preventing access to make sure the user notices. The file system will be accessible again after the user deletes the integrity state file.&quot;</span>;</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    <span class="keywordflow">case</span> 25:</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        strErr = <span class="stringliteral">&quot;An integrity violation was detected and the file system unmounted to make sure the user notices.&quot;</span>;</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="keywordflow">case</span> 26:</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;        strErr = <span class="stringliteral">&quot;Mount directory is not empty.&quot;</span>;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    <span class="keywordflow">case</span> 27:</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;        strErr = <span class="stringliteral">&quot;Mount directory in use.&quot;</span>;</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="keywordflow">case</span> 28:</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        strErr = <span class="stringliteral">&quot;Cryfs not installed.&quot;</span>;</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;    <span class="keywordflow">case</span> 29:</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        strErr = <span class="stringliteral">&quot;Mount directory doesn&#39;t exist.&quot;</span>;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keywordflow">case</span> 30:</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        strErr = <span class="stringliteral">&quot;Mounted directory encrypted.&quot;</span>;</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="keywordflow">case</span> 31:</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        strErr = <span class="stringliteral">&quot;No permissions.&quot;</span>;</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keywordflow">case</span> 32:</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;        strErr = <span class="stringliteral">&quot;Fusermount does not exist&quot;</span>;</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    <span class="keywordflow">case</span> 33:</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;        strErr = <span class="stringliteral">&quot;An encrypted folder created by Cryfs already exists.&quot;</span>;</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    <span class="keywordflow">default</span>:</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;        <span class="keywordflow">break</span>;</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;    }</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    <span class="keywordflow">return</span> strErr;</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;}</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div><div class="line"><a name="l00855"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a7857ca70e5ac1f0f0c20f0b655c8f876">  855</a></span>&#160;QString <a class="code" href="class_vault_controller.html#a7857ca70e5ac1f0f0c20f0b655c8f876">VaultController::toInternalPath</a>(<span class="keyword">const</span> QString &amp;externalPath)</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;{</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;    QString ret = externalPath;</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url(externalPath);</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;    <span class="keywordflow">if</span> (url.isVaultFile()) {</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;        QString path = url.toString();</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;        ret = path.replace(DFMVAULT_ROOT, VaultController::makeVaultUrl(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">VaultController::makeVaultLocalPath</a>()).toString());</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;    }</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="keywordflow">return</span> ret;</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;}</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;</div><div class="line"><a name="l00866"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a08a2dedb3ecf696ed67db271bb7e315b">  866</a></span>&#160;QString <a class="code" href="class_vault_controller.html#a08a2dedb3ecf696ed67db271bb7e315b">VaultController::toExternalPath</a>(<span class="keyword">const</span> QString &amp;internalPath)</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;{</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    QString retPath = internalPath;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    QString vaultRootPath = VaultController::makeVaultUrl(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">VaultController::makeVaultLocalPath</a>()).toString();</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    retPath = retPath.replace(vaultRootPath, DFMVAULT_ROOT);</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    <span class="keywordflow">return</span> retPath;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;}</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;</div><div class="line"><a name="l00875"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a4eaa03cfa01d5ed74d74940cadc279c6">  875</a></span>&#160;qint64 <a class="code" href="class_vault_controller.html#a4eaa03cfa01d5ed74d74940cadc279c6">VaultController::totalsize</a>()<span class="keyword"> const</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;<span class="keyword"></span>{</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    <span class="keywordflow">return</span> m_totalSize;</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;}</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno"><a class="line" href="class_vault_controller.html#ab8e426cfd44206558b44592cd621bd6f">  880</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_vault_controller.html#ab8e426cfd44206558b44592cd621bd6f">VaultController::setBigFileIsDeleting</a>(<span class="keyword">const</span> <span class="keywordtype">bool</span> isDeleting)</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;{</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    m_isBigFileDeleting = isDeleting;</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;}</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;<span class="keywordtype">void</span> VaultController::updateFolderSizeLabel(<span class="keyword">const</span> qint64 size) noexcept</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;{</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    m_totalSize = size;</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;}</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;</div><div class="line"><a name="l00890"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a0d01b851bcd3d96d87b1330cd7274ec5">  890</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#a0d01b851bcd3d96d87b1330cd7274ec5">VaultController::isVaultFile</a>(QString path)</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;{</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    <span class="keywordtype">bool</span> bVaultFile = <span class="keyword">false</span>;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    QString rootPath = <a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>();</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    <span class="keywordflow">if</span> (rootPath.back() == <span class="stringliteral">&quot;/&quot;</span>) {</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;        rootPath.chop(1);</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    }</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    <span class="keywordflow">if</span> (path.contains(rootPath) &amp;&amp; path.left(6) != <span class="stringliteral">&quot;search&quot;</span>) {</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;        bVaultFile = <span class="keyword">true</span>;</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    }</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    <span class="keywordflow">return</span> bVaultFile;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;}</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;</div><div class="line"><a name="l00905"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a7afdcf55f4167e279626fd4ec703c8c5">  905</a></span>&#160;QFileDevice::Permissions <a class="code" href="class_vault_controller.html#a7afdcf55f4167e279626fd4ec703c8c5">VaultController::getPermissions</a>(QString filePath)</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;{</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    QFileDevice::Permissions permissions;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    QT_STATBUF statBuffer;</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;    <span class="keywordflow">if</span> (QT_STAT(QFile::encodeName(filePath), &amp;statBuffer) == 0) {</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;        <span class="keyword">auto</span> st_mode = statBuffer.st_mode;</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;        <span class="keyword">auto</span> setPermission = [&amp;](<span class="keywordtype">bool</span> isOwner, QFileDevice::Permissions permission) {</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;            <span class="keywordflow">if</span> (isOwner) {</div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;                permissions |= permission;</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;            } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;                permissions &amp;= ~permission;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;            }</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        };</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        setPermission(st_mode &amp; S_IRUSR, QFileDevice::ReadOwner);</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;        setPermission(st_mode &amp; S_IWUSR, QFileDevice::WriteOwner);</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        setPermission(st_mode &amp; S_IXUSR, QFileDevice::ExeOwner);</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        setPermission(st_mode &amp; S_IRUSR, QFileDevice::ReadUser);</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        setPermission(st_mode &amp; S_IWUSR, QFileDevice::WriteUser);</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        setPermission(st_mode &amp; S_IXUSR, QFileDevice::ExeUser);</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;</div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;        setPermission(st_mode &amp; S_IRGRP, QFileDevice::ReadGroup);</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;        setPermission(st_mode &amp; S_IWGRP, QFileDevice::WriteGroup);</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;        setPermission(st_mode &amp; S_IXGRP, QFileDevice::ExeGroup);</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        setPermission(st_mode &amp; S_IROTH, QFileDevice::ReadOther);</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        setPermission(st_mode &amp; S_IWOTH, QFileDevice::WriteOther);</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        setPermission(st_mode &amp; S_IXOTH, QFileDevice::ExeOther);</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;    }</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    <span class="keywordflow">return</span> permissions;</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;}</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;QString VaultController::pathToVirtualPath(QString path)</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;{</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    QString nextPath = path;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    <span class="keywordtype">int</span> index = nextPath.indexOf(VAULT_DECRYPT_DIR_NAME);</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    <span class="keywordflow">if</span> (index == -1) {</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        <span class="comment">// fallback to vault file root dir.</span></div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        <span class="keywordflow">return</span> VaultController::makeVaultUrl(<span class="stringliteral">&quot;/&quot;</span>).toString();</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;    }</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    index += QString(VAULT_DECRYPT_DIR_NAME).length();</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    <span class="keywordflow">return</span> VaultController::makeVaultUrl(nextPath.mid(index)).toString();</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;}</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<a class="code" href="class_d_url.html">DUrl</a> VaultController::urlToVirtualUrl(QString path)</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;{</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;    QString nextPath = path;</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;    <span class="keywordtype">int</span> index = nextPath.indexOf(VAULT_DECRYPT_DIR_NAME);</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    <span class="keywordflow">if</span> (index == -1) {</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        <span class="comment">// fallback to vault file root dir.</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        <span class="keywordflow">return</span> VaultController::makeVaultUrl(<span class="stringliteral">&quot;/&quot;</span>);</div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    }</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    index += QString(VAULT_DECRYPT_DIR_NAME).length();</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    <span class="keywordflow">return</span> VaultController::makeVaultUrl(nextPath.mid(index));</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;}</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;</div><div class="line"><a name="l00968"></a><span class="lineno"><a class="line" href="class_vault_controller.html#af927c0fc91973fd5d36882bc9597b58e">  968</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="class_vault_controller.html#af927c0fc91973fd5d36882bc9597b58e">VaultController::isBigFileDeleting</a>()</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;{</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    <span class="keywordflow">return</span> m_isBigFileDeleting;</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;}</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;</div><div class="line"><a name="l00973"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a145b9bd269cd07d1ef043858a4c0a6c5">  973</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_vault_controller.html#a145b9bd269cd07d1ef043858a4c0a6c5">VaultController::createVault</a>(<span class="keyword">const</span> DSecureString &amp;password, QString lockBaseDir, QString unlockFileDir)</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;{</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    <span class="keyword">auto</span> createIfNotExist = [](<span class="keyword">const</span> QString &amp; path) {</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        <span class="keywordflow">if</span> (!QFile::exists(path)) {</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;            QDir().mkpath(path);</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        }</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    };</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    <span class="keywordflow">if</span> (lockBaseDir.isEmpty() || unlockFileDir.isEmpty()) {</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>() != NotExisted) {</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;            emit <a class="code" href="class_vault_controller.html#afd96500f498823c956ca1910f060a219">signalCreateVault</a>(static_cast&lt;int&gt;(ErrorCode::EncryptedExist));</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        }</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        createIfNotExist(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>, VAULT_ENCRYPY_DIR_NAME));</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        createIfNotExist(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>, VAULT_DECRYPT_DIR_NAME));</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;</div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        emit <a class="code" href="class_vault_controller.html#a4928d1f5723b957ca53dd313f6a6a04d">sigCreateVault</a>(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>, VAULT_ENCRYPY_DIR_NAME),</div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;                            <a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>, VAULT_DECRYPT_DIR_NAME),</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;                            password);</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>(lockBaseDir) != NotExisted) {</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;            emit <a class="code" href="class_vault_controller.html#afd96500f498823c956ca1910f060a219">signalCreateVault</a>(static_cast&lt;int&gt;(ErrorCode::EncryptedExist));</div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;        }</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        createIfNotExist(lockBaseDir);</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;        createIfNotExist(unlockFileDir);</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;        emit <a class="code" href="class_vault_controller.html#a4928d1f5723b957ca53dd313f6a6a04d">sigCreateVault</a>(lockBaseDir, unlockFileDir, password);</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    }</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;}</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;</div><div class="line"><a name="l01005"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a3a328deefe113d229d38da4b56a5d6df"> 1005</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_vault_controller.html#a3a328deefe113d229d38da4b56a5d6df">VaultController::unlockVault</a>(<span class="keyword">const</span> DSecureString &amp;password, QString lockBaseDir, QString unlockFileDir)</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;{</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;    <span class="comment">// 修复bug-52351</span></div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;    <span class="comment">// 保险箱解锁前,创建挂载目录</span></div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    QString strPath = <a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>, VAULT_DECRYPT_DIR_NAME);</div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;    <span class="keywordflow">if</span>(QFile::exists(strPath)) {    <span class="comment">// 如果存在,则清空目录</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        QDir dir(strPath);</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;        <span class="keywordflow">if</span>(!dir.isEmpty()) {</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;            QDirIterator dirsIterator(strPath, QDir::AllEntries | QDir::NoDotAndDotDot);</div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;            <span class="keywordflow">while</span>(dirsIterator.hasNext()) {</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;                <span class="keywordflow">if</span>(!dir.remove(dirsIterator.next())) {</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;                    QDir(dirsIterator.filePath()).removeRecursively();</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;                }</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;            }</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        }</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;    } <span class="keywordflow">else</span> {    <span class="comment">// 如果不存在,则创建目录</span></div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        QDir().mkpath(strPath);</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;    }</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;    <span class="keywordflow">if</span> (lockBaseDir.isEmpty() || unlockFileDir.isEmpty()) {</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>() != Encrypted) {</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;            emit <a class="code" href="class_vault_controller.html#aaccf57d055f3f727aa585549c179b5bb">signalUnlockVault</a>(static_cast&lt;int&gt;(ErrorCode::MountpointNotEmpty));</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;        }</div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;        emit <a class="code" href="class_vault_controller.html#a639ee329872844d0452a7b7080a720f7">sigUnlockVault</a>(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>, VAULT_ENCRYPY_DIR_NAME),</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;                            <a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>, VAULT_DECRYPT_DIR_NAME),</div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;                            password);</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>(lockBaseDir) != Encrypted) {</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;            emit <a class="code" href="class_vault_controller.html#aaccf57d055f3f727aa585549c179b5bb">signalUnlockVault</a>(static_cast&lt;int&gt;(ErrorCode::MountpointNotEmpty));</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;        }</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        emit <a class="code" href="class_vault_controller.html#a639ee329872844d0452a7b7080a720f7">sigUnlockVault</a>(lockBaseDir, unlockFileDir, password);</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    }</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;}</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;</div><div class="line"><a name="l01042"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a2da7ace850e0dc400ff69509770da8a0"> 1042</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_vault_controller.html#a2da7ace850e0dc400ff69509770da8a0">VaultController::lockVault</a>(QString lockBaseDir, QString unlockFileDir)</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;{</div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;    <span class="keywordflow">if</span> (lockBaseDir.isEmpty() || unlockFileDir.isEmpty()) {</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>() != Unlocked) {</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;            emit <a class="code" href="class_vault_controller.html#a294d12400f0cf4e0adc7b591833d13f7">signalLockVault</a>(static_cast&lt;int&gt;(ErrorCode::MountdirEncrypted));</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;        }</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        emit <a class="code" href="class_vault_controller.html#a1ab9aa68e6dea6a4b0098bc082cdaa2f">sigLockVault</a>(<a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>, VAULT_DECRYPT_DIR_NAME));</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;    } <span class="keywordflow">else</span> {</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>(lockBaseDir) != Unlocked) {</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;            emit <a class="code" href="class_vault_controller.html#a294d12400f0cf4e0adc7b591833d13f7">signalLockVault</a>(static_cast&lt;int&gt;(ErrorCode::MountdirEncrypted));</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;        }</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;        emit <a class="code" href="class_vault_controller.html#a1ab9aa68e6dea6a4b0098bc082cdaa2f">sigLockVault</a>(unlockFileDir);</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    }</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;}</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;</div><div class="line"><a name="l01059"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69"> 1059</a></span>&#160;QString <a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">VaultController::makeVaultLocalPath</a>(QString path, QString base)</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;{</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    <span class="keywordflow">if</span> (base.isEmpty()) {</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        base = VAULT_DECRYPT_DIR_NAME;</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    }</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    <span class="keywordflow">return</span> VAULT_BASE_PATH + QDir::separator() + base + (path.startsWith(<span class="charliteral">&#39;/&#39;</span>) ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;/&quot;</span>) + path;</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;}</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;</div><div class="line"><a name="l01067"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a5c04fc6ca365e15c04f784e8a24ec4ac"> 1067</a></span>&#160;QString <a class="code" href="class_vault_controller.html#a5c04fc6ca365e15c04f784e8a24ec4ac">VaultController::vaultLockPath</a>()</div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;{</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>, VAULT_ENCRYPY_DIR_NAME);</div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;}</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;</div><div class="line"><a name="l01072"></a><span class="lineno"><a class="line" href="class_vault_controller.html#ae7d3776d7c11c3cf051d7a86ffea2eb2"> 1072</a></span>&#160;QString <a class="code" href="class_vault_controller.html#ae7d3776d7c11c3cf051d7a86ffea2eb2">VaultController::vaultUnlockPath</a>()</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;{</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">makeVaultLocalPath</a>(<span class="stringliteral">&quot;&quot;</span>, VAULT_DECRYPT_DIR_NAME);</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;}</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;</div><div class="line"><a name="l01077"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a842eb93e358a47228a84d03fdfe24fd7"> 1077</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_vault_controller.html#a842eb93e358a47228a84d03fdfe24fd7">VaultController::refreshTotalSize</a>()</div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;{</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;    <span class="comment">// 修复BUG-42897 打开正在拷贝或剪贴的文件夹时，主界面卡死问题</span></div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;    <span class="comment">// 当保险箱大小计算线程没有结束时，直接返回</span></div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <span class="keywordflow">if</span> (m_sizeWorker-&gt;isRunning()) {</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;        m_bNeedRefreshSize = <span class="keyword">true</span>;</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;        <span class="keywordflow">return</span>;</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;    }</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    <a class="code" href="class_d_url.html">DUrl</a> url = vaultToLocalUrl(makeVaultUrl());</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;    m_sizeWorker-&gt;start({url});</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;}</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;</div><div class="line"><a name="l01090"></a><span class="lineno"><a class="line" href="class_vault_controller.html#a2337b3c317a3a264fb72e558c49ef488"> 1090</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="class_vault_controller.html#a2337b3c317a3a264fb72e558c49ef488">VaultController::onFinishCalcSize</a>()</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;{</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    <span class="comment">// 但保险箱大小计算完成后，再次计算一次保险箱的大小</span></div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    <span class="keywordflow">if</span> (m_bNeedRefreshSize) {</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;        <a class="code" href="class_d_url.html">DUrl</a> url = vaultToLocalUrl(makeVaultUrl());</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        <span class="comment">// 修复BUG-47507 增加判断，如果该线程正在启动，不要再次进入该线程</span></div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        <span class="keywordflow">if</span> (!m_sizeWorker-&gt;isRunning())</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;            m_sizeWorker-&gt;start({url});</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    }</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    m_bNeedRefreshSize = <span class="keyword">false</span>;</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;}</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;<span class="comment">// 创建保险箱，执行该槽函数,通知保险箱创建成功与否，并更新保险箱的状态</span></div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;<span class="keywordtype">void</span> VaultController::slotCreateVault(<span class="keywordtype">int</span> <a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>)</div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;{</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    <span class="keywordflow">if</span> (state == static_cast&lt;int&gt;(ErrorCode::Success)) {</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        m_enVaultState = Unlocked;</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    }</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    emit <a class="code" href="class_vault_controller.html#afd96500f498823c956ca1910f060a219">signalCreateVault</a>(state);</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;}</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;<span class="keywordtype">void</span> VaultController::slotUnlockVault(<span class="keywordtype">int</span> <a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>)</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;{</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;    <span class="keywordflow">if</span> (state == static_cast&lt;int&gt;(ErrorCode::Success)) {</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        m_enVaultState = Unlocked;</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    }</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;    emit <a class="code" href="class_vault_controller.html#aaccf57d055f3f727aa585549c179b5bb">signalUnlockVault</a>(state);</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;}</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;<span class="keywordtype">void</span> VaultController::slotLockVault(<span class="keywordtype">int</span> <a class="code" href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">state</a>)</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;{</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;    <span class="keywordflow">if</span> (state == static_cast&lt;int&gt;(ErrorCode::Success)) {</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;        m_enVaultState = Encrypted;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    }</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    emit <a class="code" href="class_vault_controller.html#a294d12400f0cf4e0adc7b591833d13f7">signalLockVault</a>(state);</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;}</div><div class="ttc" id="class_cry_fs_handle_html"><div class="ttname"><a href="class_cry_fs_handle.html">CryFsHandle</a></div><div class="ttdef"><b>Definition:</b> <a href="vaulthandle_8h_source.html#l00033">vaulthandle.h:33</a></div></div>
<div class="ttc" id="class_cry_fs_handle_html_a39109e9312dfb471653589206e7465d6"><div class="ttname"><a href="class_cry_fs_handle.html#a39109e9312dfb471653589206e7465d6">CryFsHandle::lockVault</a></div><div class="ttdeci">void lockVault(QString unlockFileDir)</div><div class="ttdoc">lockedStrongBox 加锁保险箱 </div><div class="ttdef"><b>Definition:</b> <a href="vaulthandle_8cpp_source.html#l00074">vaulthandle.cpp:74</a></div></div>
<div class="ttc" id="class_vault_controller_html_a396bef84d7f2fcb0a51c5b0930451d8b"><div class="ttname"><a href="class_vault_controller.html#a396bef84d7f2fcb0a51c5b0930451d8b">VaultController::createSymlink</a></div><div class="ttdeci">bool createSymlink(const QSharedPointer&lt; DFMCreateSymlinkEvent &gt; &amp;event) const override</div><div class="ttdoc">createSymlink 创建快捷方式 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00536">vaultcontroller.cpp:536</a></div></div>
<div class="ttc" id="class_vault_controller_html_ac53b08b43f3169a10529f45b94d8394c"><div class="ttname"><a href="class_vault_controller.html#ac53b08b43f3169a10529f45b94d8394c">VaultController::signalFileDeleted</a></div><div class="ttdeci">void signalFileDeleted()</div><div class="ttdoc">signalFileDeleted 文件删除完成信号 </div></div>
<div class="ttc" id="class_vault_controller_html_aaccf57d055f3f727aa585549c179b5bb"><div class="ttname"><a href="class_vault_controller.html#aaccf57d055f3f727aa585549c179b5bb">VaultController::signalUnlockVault</a></div><div class="ttdeci">void signalUnlockVault(int state)</div><div class="ttdoc">singalUnlockVault 解锁保险箱是否成功的信号 </div></div>
<div class="ttc" id="class_d_file_watcher_html"><div class="ttname"><a href="class_d_file_watcher.html">DFileWatcher</a></div><div class="ttdef"><b>Definition:</b> <a href="dfilewatcher_8h_source.html#l00016">dfilewatcher.h:16</a></div></div>
<div class="ttc" id="class_vault_controller_html_ae7d3776d7c11c3cf051d7a86ffea2eb2"><div class="ttname"><a href="class_vault_controller.html#ae7d3776d7c11c3cf051d7a86ffea2eb2">VaultController::vaultUnlockPath</a></div><div class="ttdeci">static QString vaultUnlockPath()</div><div class="ttdoc">vaultLockPath 返回默认保险箱解密文件夹路径，如路径是外部传入暂时无法获取 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l01072">vaultcontroller.cpp:1072</a></div></div>
<div class="ttc" id="class_cry_fs_handle_html_af6b251a9a56e20fbb3aef290dc7694b3"><div class="ttname"><a href="class_cry_fs_handle.html#af6b251a9a56e20fbb3aef290dc7694b3">CryFsHandle::signalLockVault</a></div><div class="ttdeci">void signalLockVault(int state)</div><div class="ttdoc">signalLockVault 加锁保险箱是否成功的信号 </div></div>
<div class="ttc" id="class_cry_fs_handle_html_a38f5e500d5ecffb59b2816c8d42714a8"><div class="ttname"><a href="class_cry_fs_handle.html#a38f5e500d5ecffb59b2816c8d42714a8">CryFsHandle::signalReadError</a></div><div class="ttdeci">void signalReadError(QString error)</div><div class="ttdoc">readError 错误输出 </div></div>
<div class="ttc" id="class_vault_controller_html_afd96500f498823c956ca1910f060a219"><div class="ttname"><a href="class_vault_controller.html#afd96500f498823c956ca1910f060a219">VaultController::signalCreateVault</a></div><div class="ttdeci">void signalCreateVault(int state)</div><div class="ttdoc">signalCreateVault 创建保险箱是否成功的信号 </div></div>
<div class="ttc" id="class_d_abstract_file_watcher_html"><div class="ttname"><a href="class_d_abstract_file_watcher.html">DAbstractFileWatcher</a></div><div class="ttdef"><b>Definition:</b> <a href="dabstractfilewatcher_8h_source.html#l00017">dabstractfilewatcher.h:17</a></div></div>
<div class="ttc" id="class_vault_controller_html_af927c0fc91973fd5d36882bc9597b58e"><div class="ttname"><a href="class_vault_controller.html#af927c0fc91973fd5d36882bc9597b58e">VaultController::isBigFileDeleting</a></div><div class="ttdeci">static bool isBigFileDeleting()</div><div class="ttdoc">isDeleteFiles 判断保险箱当前是否正在删除文件 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00968">vaultcontroller.cpp:968</a></div></div>
<div class="ttc" id="class_vault_controller_html_a639ee329872844d0452a7b7080a720f7"><div class="ttname"><a href="class_vault_controller.html#a639ee329872844d0452a7b7080a720f7">VaultController::sigUnlockVault</a></div><div class="ttdeci">void sigUnlockVault(QString lockBaseDir, QString unlockFileDir, QString passWord)</div><div class="ttdoc">sigUnlockVault 解锁保险箱信号 </div></div>
<div class="ttc" id="class_d_abstract_file_controller_html"><div class="ttname"><a href="class_d_abstract_file_controller.html">DAbstractFileController</a></div><div class="ttdef"><b>Definition:</b> <a href="dabstractfilecontroller_8h_source.html#l00077">dabstractfilecontroller.h:77</a></div></div>
<div class="ttc" id="class_vault_controller_private_html"><div class="ttname"><a href="class_vault_controller_private.html">VaultControllerPrivate</a></div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00062">vaultcontroller.cpp:62</a></div></div>
<div class="ttc" id="class_vault_controller_html_a39c59f624991247ec4afea13b83b9d63"><div class="ttname"><a href="class_vault_controller.html#a39c59f624991247ec4afea13b83b9d63">VaultController::shareFolder</a></div><div class="ttdeci">bool shareFolder(const QSharedPointer&lt; DFMFileShareEvent &gt; &amp;event) const override</div><div class="ttdoc">shareFolder 设置文件夹共享 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00466">vaultcontroller.cpp:466</a></div></div>
<div class="ttc" id="class_vault_controller_html_a9505834512bb967ccdc47edb3188d853"><div class="ttname"><a href="class_vault_controller.html#a9505834512bb967ccdc47edb3188d853">VaultController::signalReadOutput</a></div><div class="ttdeci">void signalReadOutput(QString msg)</div><div class="ttdoc">signalReadOutput 标准输出 </div></div>
<div class="ttc" id="class_vault_controller_html_ac56878a5fe44d21fbb918db40d8c1609"><div class="ttname"><a href="class_vault_controller.html#ac56878a5fe44d21fbb918db40d8c1609">VaultController::unShareFolder</a></div><div class="ttdeci">bool unShareFolder(const QSharedPointer&lt; DFMCancelFileShareEvent &gt; &amp;event) const override</div><div class="ttdoc">unShareFolder 取消文件夹共享 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00480">vaultcontroller.cpp:480</a></div></div>
<div class="ttc" id="struct_vault_controller_1_1_file_base_info_html"><div class="ttname"><a href="struct_vault_controller_1_1_file_base_info.html">VaultController::FileBaseInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8h_source.html#l00050">vaultcontroller.h:50</a></div></div>
<div class="ttc" id="class_cry_fs_handle_html_a5151929e494830356c84c73689249528"><div class="ttname"><a href="class_cry_fs_handle.html#a5151929e494830356c84c73689249528">CryFsHandle::signalUnlockVault</a></div><div class="ttdeci">void signalUnlockVault(int state)</div><div class="ttdoc">singalUnlockVault 解锁保险箱是否成功的信号 </div></div>
<div class="ttc" id="class_vault_controller_html_a2337b3c317a3a264fb72e558c49ef488"><div class="ttname"><a href="class_vault_controller.html#a2337b3c317a3a264fb72e558c49ef488">VaultController::onFinishCalcSize</a></div><div class="ttdeci">void onFinishCalcSize()</div><div class="ttdoc">refreshTotalSize 刷新保险箱大小完成 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l01090">vaultcontroller.cpp:1090</a></div></div>
<div class="ttc" id="class_cry_fs_handle_html_a4142b6f6ec015abb763bde4b6cea77c2"><div class="ttname"><a href="class_cry_fs_handle.html#a4142b6f6ec015abb763bde4b6cea77c2">CryFsHandle::signalCreateVault</a></div><div class="ttdeci">void signalCreateVault(int state)</div><div class="ttdoc">signalCreateVault 创建保险箱是否成功的信号 </div></div>
<div class="ttc" id="class_d_file_proxy_watcher_html"><div class="ttname"><a href="class_d_file_proxy_watcher.html">DFileProxyWatcher</a></div><div class="ttdef"><b>Definition:</b> <a href="dfileproxywatcher_8h_source.html#l00018">dfileproxywatcher.h:18</a></div></div>
<div class="ttc" id="class_d_storage_info_html"><div class="ttname"><a href="class_d_storage_info.html">DStorageInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="dstorageinfo_8h_source.html#l00031">dstorageinfo.h:31</a></div></div>
<div class="ttc" id="class_tag_manager_html_a5354f94aa3f655a55e52c0dcf1b1e84c"><div class="ttname"><a href="class_tag_manager.html#a5354f94aa3f655a55e52c0dcf1b1e84c">TagManager::makeFilesTags</a></div><div class="ttdeci">bool makeFilesTags(const QList&lt; QString &gt; &amp;tags, const QList&lt; DUrl &gt; &amp;files)</div><div class="ttdoc">:modify</div><div class="ttdef"><b>Definition:</b> <a href="tagmanager_8cpp_source.html#l00193">tagmanager.cpp:193</a></div></div>
<div class="ttc" id="class_vault_controller_html_a2d4d431c25403b6d04e9ec4817f67281"><div class="ttname"><a href="class_vault_controller.html#a2d4d431c25403b6d04e9ec4817f67281">VaultController::removeBookmark</a></div><div class="ttdeci">bool removeBookmark(const QSharedPointer&lt; DFMRemoveBookmarkEvent &gt; &amp;event) const override</div><div class="ttdoc">removeBookmark 移除当前文件夹书签 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00531">vaultcontroller.cpp:531</a></div></div>
<div class="ttc" id="class_vault_controller_html_a3a328deefe113d229d38da4b56a5d6df"><div class="ttname"><a href="class_vault_controller.html#a3a328deefe113d229d38da4b56a5d6df">VaultController::unlockVault</a></div><div class="ttdeci">void unlockVault(const DSecureString &amp;password, QString lockBaseDir=&quot;&quot;, QString unlockFileDir=&quot;&quot;)</div><div class="ttdoc">unlockVault 解锁保险箱 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l01005">vaultcontroller.cpp:1005</a></div></div>
<div class="ttc" id="class_vault_controller_html_a7c96f61313ec6313632089a0e38a7a3f"><div class="ttname"><a href="class_vault_controller.html#a7c96f61313ec6313632089a0e38a7a3f">VaultController::removeTagsOfFile</a></div><div class="ttdeci">bool removeTagsOfFile(const QSharedPointer&lt; DFMRemoveTagsOfFileEvent &gt; &amp;event) const override</div><div class="ttdoc">removeTagsOfFile 移除文件标记信息 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00584">vaultcontroller.cpp:584</a></div></div>
<div class="ttc" id="class_vault_controller_html_a7afdcf55f4167e279626fd4ec703c8c5"><div class="ttname"><a href="class_vault_controller.html#a7afdcf55f4167e279626fd4ec703c8c5">VaultController::getPermissions</a></div><div class="ttdeci">static QFileDevice::Permissions getPermissions(QString filePath)</div><div class="ttdoc">getPermissions 获取文件的权限信息 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00905">vaultcontroller.cpp:905</a></div></div>
<div class="ttc" id="class_vault_controller_html_a88cf7958cc1f514da5e5e45810338d69"><div class="ttname"><a href="class_vault_controller.html#a88cf7958cc1f514da5e5e45810338d69">VaultController::makeVaultLocalPath</a></div><div class="ttdeci">static QString makeVaultLocalPath(QString path=&quot;&quot;, QString base=&quot;&quot;)</div><div class="ttdoc">makeVaultLocalPath 创建本地路径 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l01059">vaultcontroller.cpp:1059</a></div></div>
<div class="ttc" id="class_vault_controller_html_a08a2dedb3ecf696ed67db271bb7e315b"><div class="ttname"><a href="class_vault_controller.html#a08a2dedb3ecf696ed67db271bb7e315b">VaultController::toExternalPath</a></div><div class="ttdeci">static QString toExternalPath(const QString &amp;internalPath)</div><div class="ttdoc">toExternalPath 转换成外部路径 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00866">vaultcontroller.cpp:866</a></div></div>
<div class="ttc" id="class_vault_controller_html_add45f1dbf93b72756db353bf7a782d50"><div class="ttname"><a href="class_vault_controller.html#add45f1dbf93b72756db353bf7a782d50">VaultController::VaultController</a></div><div class="ttdeci">VaultController(QObject *parent=nullptr)</div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00200">vaultcontroller.cpp:200</a></div></div>
<div class="ttc" id="class_vault_controller_html_a1ab9aa68e6dea6a4b0098bc082cdaa2f"><div class="ttname"><a href="class_vault_controller.html#a1ab9aa68e6dea6a4b0098bc082cdaa2f">VaultController::sigLockVault</a></div><div class="ttdeci">void sigLockVault(QString unlockFileDir)</div><div class="ttdoc">sigLockVault 加锁保险箱信号 </div></div>
<div class="ttc" id="class_share_info_html"><div class="ttname"><a href="class_share_info.html">ShareInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="shareinfo_8h_source.html#l00032">shareinfo.h:32</a></div></div>
<div class="ttc" id="class_vault_controller_html_ab33662db60d59b563219ecc6cbfa1861"><div class="ttname"><a href="class_vault_controller.html#ab33662db60d59b563219ecc6cbfa1861">VaultController::signalReadError</a></div><div class="ttdeci">void signalReadError(QString error)</div><div class="ttdoc">readError 错误输出 </div></div>
<div class="ttc" id="class_vault_file_info_html"><div class="ttname"><a href="class_vault_file_info.html">VaultFileInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="vaultfileinfo_8h_source.html#l00029">vaultfileinfo.h:29</a></div></div>
<div class="ttc" id="class_vault_controller_html_a196157fb914802a63c1cc57a36bc6cc9"><div class="ttname"><a href="class_vault_controller.html#a196157fb914802a63c1cc57a36bc6cc9">VaultController::getTagsThroughFiles</a></div><div class="ttdeci">QList&lt; QString &gt; getTagsThroughFiles(const QSharedPointer&lt; DFMGetTagsThroughFilesEvent &gt; &amp;event) const override</div><div class="ttdoc">getTagsThroughFiles 获取文件标记信息 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00592">vaultcontroller.cpp:592</a></div></div>
<div class="ttc" id="class_vault_controller_html_a8580d427cdd9bd9ea9040c1a58415227"><div class="ttname"><a href="class_vault_controller.html#a8580d427cdd9bd9ea9040c1a58415227">VaultController::setFileTags</a></div><div class="ttdeci">bool setFileTags(const QSharedPointer&lt; DFMSetFileTagsEvent &gt; &amp;event) const override</div><div class="ttdoc">setFileTags 设置文件标记信息 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00570">vaultcontroller.cpp:570</a></div></div>
<div class="ttc" id="class_d_f_m_file_list_file_html"><div class="ttname"><a href="class_d_f_m_file_list_file.html">DFMFileListFile</a></div><div class="ttdef"><b>Definition:</b> <a href="dfmfilelistfile_8h_source.html#l00027">dfmfilelistfile.h:27</a></div></div>
<div class="ttc" id="class_vault_dir_iterator_html"><div class="ttname"><a href="class_vault_dir_iterator.html">VaultDirIterator</a></div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00079">vaultcontroller.cpp:79</a></div></div>
<div class="ttc" id="class_vault_controller_html_a294d12400f0cf4e0adc7b591833d13f7"><div class="ttname"><a href="class_vault_controller.html#a294d12400f0cf4e0adc7b591833d13f7">VaultController::signalLockVault</a></div><div class="ttdeci">void signalLockVault(int state)</div><div class="ttdoc">signalLockVault 加锁保险箱是否成功的信号 </div></div>
<div class="ttc" id="class_vault_controller_html_a7857ca70e5ac1f0f0c20f0b655c8f876"><div class="ttname"><a href="class_vault_controller.html#a7857ca70e5ac1f0f0c20f0b655c8f876">VaultController::toInternalPath</a></div><div class="ttdeci">static QString toInternalPath(const QString &amp;externalPath)</div><div class="ttdoc">toInternalPath 外部路径转内部路径 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00855">vaultcontroller.cpp:855</a></div></div>
<div class="ttc" id="class_vault_controller_html_abffd69b376a26d943d859afb91a395ec"><div class="ttname"><a href="class_vault_controller.html#abffd69b376a26d943d859afb91a395ec">VaultController::openInTerminal</a></div><div class="ttdeci">bool openInTerminal(const QSharedPointer&lt; DFMOpenInTerminalEvent &gt; &amp;event) const override</div><div class="ttdoc">openInTerminal 右键菜单打开当前路径终端 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00488">vaultcontroller.cpp:488</a></div></div>
<div class="ttc" id="class_vault_controller_html_a842eb93e358a47228a84d03fdfe24fd7"><div class="ttname"><a href="class_vault_controller.html#a842eb93e358a47228a84d03fdfe24fd7">VaultController::refreshTotalSize</a></div><div class="ttdeci">void refreshTotalSize()</div><div class="ttdoc">refreshTotalSize 刷新保险箱大小 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l01077">vaultcontroller.cpp:1077</a></div></div>
<div class="ttc" id="class_d_file_statistics_job_html"><div class="ttname"><a href="class_d_file_statistics_job.html">DFileStatisticsJob</a></div><div class="ttdef"><b>Definition:</b> <a href="dfilestatisticsjob_8h_source.html#l00031">dfilestatisticsjob.h:31</a></div></div>
<div class="ttc" id="class_filter_appender_html_ad088cfbc3d5cf80f38d59eb7b19d19db"><div class="ttname"><a href="class_filter_appender.html#ad088cfbc3d5cf80f38d59eb7b19d19db">FilterAppender::addFilter</a></div><div class="ttdeci">void addFilter(const QString &amp;filterField)</div><div class="ttdoc">addFilter 添加过滤关键字 </div><div class="ttdef"><b>Definition:</b> <a href="filter_appender_8cpp_source.html#l00251">filterAppender.cpp:251</a></div></div>
<div class="ttc" id="class_vault_controller_html_a4eaa03cfa01d5ed74d74940cadc279c6"><div class="ttname"><a href="class_vault_controller.html#a4eaa03cfa01d5ed74d74940cadc279c6">VaultController::totalsize</a></div><div class="ttdeci">qint64 totalsize() const</div><div class="ttdoc">totalsize 保险箱大小 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00875">vaultcontroller.cpp:875</a></div></div>
<div class="ttc" id="class_vault_controller_html_a402993d761fd9cc86d1d7b0ae8b5d1b7"><div class="ttname"><a href="class_vault_controller.html#a402993d761fd9cc86d1d7b0ae8b5d1b7">VaultController::createFileInfo</a></div><div class="ttdeci">const DAbstractFileInfoPointer createFileInfo(const QSharedPointer&lt; DFMCreateFileInfoEvent &gt; &amp;event) const override</div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00251">vaultcontroller.cpp:251</a></div></div>
<div class="ttc" id="class_vault_controller_html_ab9f92856da6290e1d8909c755111427e"><div class="ttname"><a href="class_vault_controller.html#ab9f92856da6290e1d8909c755111427e">VaultController::getErrorInfo</a></div><div class="ttdeci">static QString getErrorInfo(int state)</div><div class="ttdoc">getErrorInfo 根据错误码获取错误信息 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00772">vaultcontroller.cpp:772</a></div></div>
<div class="ttc" id="class_cry_fs_handle_html_ac3677f7b383527dda9138f7e73c90aa1"><div class="ttname"><a href="class_cry_fs_handle.html#ac3677f7b383527dda9138f7e73c90aa1">CryFsHandle::createVault</a></div><div class="ttdeci">void createVault(QString lockBaseDir, QString unlockFileDir, QString passWord)</div><div class="ttdoc">createVault 创建保险箱 </div><div class="ttdef"><b>Definition:</b> <a href="vaulthandle_8cpp_source.html#l00047">vaulthandle.cpp:47</a></div></div>
<div class="ttc" id="class_vault_controller_html_a755c637695ee3e91c82086278f96e166"><div class="ttname"><a href="class_vault_controller.html#a755c637695ee3e91c82086278f96e166">VaultController::isRootDirectory</a></div><div class="ttdeci">static bool isRootDirectory(QString path)</div><div class="ttdoc">VaultFileInfo::isRootDirectory 是否为保险箱根目录 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00759">vaultcontroller.cpp:759</a></div></div>
<div class="ttc" id="class_cry_fs_handle_html_a4364984179e53728f25744589a540bdf"><div class="ttname"><a href="class_cry_fs_handle.html#a4364984179e53728f25744589a540bdf">CryFsHandle::signalReadOutput</a></div><div class="ttdeci">void signalReadOutput(QString msg)</div><div class="ttdoc">signalReadOutput 标准输出 </div></div>
<div class="ttc" id="class_d_f_m_file_list_file_html_aae6d9de3223f561add9b3350aa3d948b"><div class="ttname"><a href="class_d_f_m_file_list_file.html#aae6d9de3223f561add9b3350aa3d948b">DFMFileListFile::save</a></div><div class="ttdeci">bool save() const</div><div class="ttdef"><b>Definition:</b> <a href="dfmfilelistfile_8cpp_source.html#l00191">dfmfilelistfile.cpp:191</a></div></div>
<div class="ttc" id="class_vault_controller_html_a7a3ffffcf3deb249f00f7f4625d59ed6"><div class="ttname"><a href="class_vault_controller.html#a7a3ffffcf3deb249f00f7f4625d59ed6">VaultController::addToBookmark</a></div><div class="ttdeci">bool addToBookmark(const QSharedPointer&lt; DFMAddToBookmarkEvent &gt; &amp;event) const override</div><div class="ttdoc">addToBookmark 添加当前文件夹书签 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00501">vaultcontroller.cpp:501</a></div></div>
<div class="ttc" id="class_cry_fs_handle_html_a55af2347d454125cacb8a2533a5db2e7"><div class="ttname"><a href="class_cry_fs_handle.html#a55af2347d454125cacb8a2533a5db2e7">CryFsHandle::unlockVault</a></div><div class="ttdeci">void unlockVault(QString lockBaseDir, QString unlockFileDir, QString passWord)</div><div class="ttdoc">unlockVault 解锁保险箱 </div><div class="ttdef"><b>Definition:</b> <a href="vaulthandle_8cpp_source.html#l00060">vaulthandle.cpp:60</a></div></div>
<div class="ttc" id="class_vault_controller_html_a4928d1f5723b957ca53dd313f6a6a04d"><div class="ttname"><a href="class_vault_controller.html#a4928d1f5723b957ca53dd313f6a6a04d">VaultController::sigCreateVault</a></div><div class="ttdeci">void sigCreateVault(QString lockBaseDir, QString unlockFileDir, QString passWord)</div><div class="ttdoc">下列信号为本类内部使用，请勿外用 </div></div>
<div class="ttc" id="class_vault_controller_html_a2da7ace850e0dc400ff69509770da8a0"><div class="ttname"><a href="class_vault_controller.html#a2da7ace850e0dc400ff69509770da8a0">VaultController::lockVault</a></div><div class="ttdeci">void lockVault(QString lockBaseDir=&quot;&quot;, QString unlockFileDir=&quot;&quot;)</div><div class="ttdoc">lockVault 加锁保险箱 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l01042">vaultcontroller.cpp:1042</a></div></div>
<div class="ttc" id="class_q_list_html"><div class="ttname"><a href="class_q_list.html">QList&lt; DUrl &gt;</a></div></div>
<div class="ttc" id="class_vault_controller_html_a5c04fc6ca365e15c04f784e8a24ec4ac"><div class="ttname"><a href="class_vault_controller.html#a5c04fc6ca365e15c04f784e8a24ec4ac">VaultController::vaultLockPath</a></div><div class="ttdeci">static QString vaultLockPath()</div><div class="ttdoc">vaultLockPath 返回默认保险箱加密文件夹路径，如路径是外部传入暂时无法获取 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l01067">vaultcontroller.cpp:1067</a></div></div>
<div class="ttc" id="class_vault_controller_html_a0d01b851bcd3d96d87b1330cd7274ec5"><div class="ttname"><a href="class_vault_controller.html#a0d01b851bcd3d96d87b1330cd7274ec5">VaultController::isVaultFile</a></div><div class="ttdeci">static bool isVaultFile(QString path)</div><div class="ttdoc">isVaultFile 是否为保险箱中的文件 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00890">vaultcontroller.cpp:890</a></div></div>
<div class="ttc" id="class_vault_controller_html_ab8e426cfd44206558b44592cd621bd6f"><div class="ttname"><a href="class_vault_controller.html#ab8e426cfd44206558b44592cd621bd6f">VaultController::setBigFileIsDeleting</a></div><div class="ttdeci">void setBigFileIsDeleting(bool const isDeleting)</div><div class="ttdoc">setBigFileIsDeleting Record big file deleting state. Avoid block while mutl-file deleted. </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00880">vaultcontroller.cpp:880</a></div></div>
<div class="ttc" id="class_vault_controller_html_abf58fbbe51e9747a0542783625d75a50"><div class="ttname"><a href="class_vault_controller.html#abf58fbbe51e9747a0542783625d75a50">VaultController::state</a></div><div class="ttdeci">VaultState state(QString lockBaseDir=&quot;&quot;)</div><div class="ttdoc">state 获取当前保险箱状态 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00731">vaultcontroller.cpp:731</a></div></div>
<div class="ttc" id="class_d_url_html"><div class="ttname"><a href="class_d_url.html">DUrl</a></div><div class="ttdef"><b>Definition:</b> <a href="durl_8h_source.html#l00087">durl.h:87</a></div></div>
<div class="ttc" id="class_d_dir_iterator_html"><div class="ttname"><a href="class_d_dir_iterator.html">DDirIterator</a></div><div class="ttdef"><b>Definition:</b> <a href="ddiriterator_8h_source.html#l00030">ddiriterator.h:30</a></div></div>
<div class="ttc" id="class_vault_controller_html"><div class="ttname"><a href="class_vault_controller.html">VaultController</a></div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8h_source.html#l00037">vaultcontroller.h:37</a></div></div>
<div class="ttc" id="class_desktop_file_info_html"><div class="ttname"><a href="class_desktop_file_info.html">DesktopFileInfo</a></div><div class="ttdef"><b>Definition:</b> <a href="desktopfileinfo_8h_source.html#l00035">desktopfileinfo.h:35</a></div></div>
<div class="ttc" id="class_vault_controller_html_a145b9bd269cd07d1ef043858a4c0a6c5"><div class="ttname"><a href="class_vault_controller.html#a145b9bd269cd07d1ef043858a4c0a6c5">VaultController::createVault</a></div><div class="ttdeci">void createVault(const DSecureString &amp;password, QString lockBaseDir=&quot;&quot;, QString unlockFileDir=&quot;&quot;)</div><div class="ttdoc">createVault 创建保险箱 </div><div class="ttdef"><b>Definition:</b> <a href="vaultcontroller_8cpp_source.html#l00973">vaultcontroller.cpp:973</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_b92aedbef8f10317dbbf98e48a7b4a23.html">dde-file-manager</a></li><li class="navelem"><a class="el" href="dir_f9029d0d717014796f47cbb96a029b81.html">dde-file-manager-lib</a></li><li class="navelem"><a class="el" href="dir_88c2fb497caf8ed7e61fe3dfc595d2a7.html">controllers</a></li><li class="navelem"><b>vaultcontroller.cpp</b></li>
    <li class="footer">生成于 2021年 二月 23日 星期二 16:38:19 , 为 develop-manual使用 
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
